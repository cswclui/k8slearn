proxy:
  title: PolyU Virtual Labs - COMP12345
  unsafe-label: true
  users:
  - name: jack
    password: password
    groups: admins, comp1234, comp2345
  - name: jeff
    password: password
  admin-groups: admins
  authentication: simple
  container-backend: kubernetes
  container-wait-time: 1200000
  template-path: /etc/shinyproxy/config/templates
  engagement:
    automatic-timeout: 60000
    enabled: true
    filter-header:
    - 33421
    - 33434
    - 33482
    max-age: PT4H
  heartbeat-rate: 10000
  heartbeat-timeout: 50000
  kubernetes:
    custom-namespace: true
    internal-networking: true
    namespace: shinyproxy
    namespace-prefix: vlab
    pod-wait-time: 120000
    image-pull-policy: Always
  landing-page: /
  livenessProbe: {}
  logo-url: https://www.openanalytics.eu/shinyproxy/logo.png
  port: 8080
  readinessProbe: {}
  same-site-cookie: none
  filebrowser:
    container-image: cswclui/myfilebrowser
    port: 9000 
    container-cmd: ["/filebrowser","-b","#{proxySpec.containerSpecs[0].env.get('SHINYPROXY_PUBLIC_PATH')}",
    "--database=/home/rootless/database.db"
    ]
    kubernetes-pod-patches: #bind container to Ceph volume
    |
      - op: add
        path: /spec/containers/0/volumeMounts
        value:
        - mountPath: "/data"
          name: "user-volume"
          # subPath: workspace
      - op: add
        path: /spec/volumes
        value:
        - name: "user-volume"
          namespace: shinyproxy
          persistentVolumeClaim:
            claimName: "ceph-pvc-#{proxy.userId}"
  specs:
  - id: vscode-mysql-python
    display-name: MySQL with Python
    description: Click the link below to access the SIDU database browser. 1
    container-image: cswclui/vscode-sidu:1.0
    container-cmd:
    - start.sh
    container-cpu-limit: 2000m #2VCPU
    container-cpu-request: 200m 
    container-memory-limit: 1000Mi
    container-memory-request: 500Mi
    container-env:
      MYSQL_ROOT_PASSWORD: 12345
    port: 8081
    courses: ["comp1001", "comp1002", "comp1003"]
    sub-apps:
    - description: 
      display-name: SIDU database browser 12345
      path: port/80/index.php
    kubernetes-pod-patches: #bind container to Ceph volume
    |
      - op: add
        path: /spec/containers/0/volumeMounts
        value:
        - mountPath: "/root/workspace"
          name: "user-volume"
          subPath: workspace/vscode-mysql-python
        - mountPath: "/root/.vscode"
          name: "user-volume"
          subPath: vscode-cfg
        - mountPath: "/var/lib/mysql"
          name: "user-volume"
          subPath: mysql
      - op: add
        path: /spec/volumes
        value:
        - name: "user-volume"
          namespace: shinyproxy
          persistentVolumeClaim:
            claimName: "ceph-pvc-#{proxy.userId}"
      - op: add
        path: /spec/containers/0/resources/requests/ephemeral-storage
        value: "1Gi"
  - id: docker-playground
    display-name: Docker playground
    description: You can try Docker using this app. 123456
    container-image: cswclui/rootless-dind:1.1
    container-cpu-limit: 2000m
    container-cpu-request: 200m
    container-memory-limit: 1500Mi
    container-memory-request: 500Mi
    container-privileged: true
    port: 8081
    kubernetes-pod-patches: #bind container to Ceph volume
    |
      - op: add
        path: /spec/containers/0/volumeMounts
        value:
        - mountPath: "/home/rootless/workspace"
          name: "user-volume"
          subPath: workspace/docker-playground
        - mountPath: "/home/rootless/app/vscode"
          name: "user-volume"
          subPath: vscode-cfg        
      - op: add
        path: /spec/volumes
        value:
        - name: "user-volume"
          namespace: shinyproxy
          persistentVolumeClaim:
            claimName: "ceph-pvc-#{proxy.userId}"
      - op: add
        path: /spec/containers/0/resources/requests/ephemeral-storage
        value: "1Gi"
  - id: rstudio_tidyverse
    description: The files will only persist if it is stored under /home/rstudio/workspace 
    display-name: RStudio
    container-image: cswclui/myrstudio:2.8
    container-cpu-limit: 2000m
    container-cpu-request: 200m
    container-memory-limit: 2000Mi
    container-memory-request: 500Mi
    container-env:
      #XDG_DATA_HOME: "/rstudio-state" #storing rstudio state data:seems ignored
      DISABLE_AUTH: true
      USERID: rstudio
      WWW_ROOT_PATH: '#{proxySpec.containerSpecs[0].env.get(''SHINYPROXY_PUBLIC_PATH'')}'
    port: 8787   
    kubernetes-pod-patches: #bind container to Ceph volume
    |
      - op: add
        path: /spec/containers/0/volumeMounts
        value:
        - mountPath: "/home/rstudio"
          name: "user-volume"
          subPath: workspace/RStudio
      - op: add
        path: /spec/volumes
        value:
        - name: "user-volume"
          namespace: shinyproxy
          persistentVolumeClaim:
            claimName: "ceph-pvc-#{proxy.userId}"
      - op: add
        path: /spec/containers/0/resources/requests/ephemeral-storage
        value: "1Gi"
  - id: jupyter
    display-name: Jupyter Notebook
    description: The id should be "jupyter" (hard-coded in the nginx rule). install package in user's home folder: !pip install --user flask
    container-image: cswclui/mynotebook:2.0
    container-cmd: ["mystart.sh", 
    "start-notebook.sh", "--NotebookApp.token=''", 
    --NotebookApp.allow_origin='*',
    --notebook-dir='/home/jovyan/workspace',
    #--notebook-dir='/home/jovyan',
    "--NotebookApp.base_url=#{proxySpec.containerSpecs[0].env.get('SHINYPROXY_PUBLIC_PATH')}"]
    container-cpu-limit: 2000m
    container-cpu-request: 200m
    container-memory-limit: 2000Mi
    container-memory-request: 400Mi
    port: 7777
    kubernetes-pod-patches: #bind container to Ceph volume
    |
      - op: add
        path: /spec/containers/0/volumeMounts
        value:
        - mountPath: "/home/jovyan/workspace"
          name: "user-volume"
          subPath: workspace/jupyter
        - mountPath: "/home/jovyan/.ipython"
          name: "user-volume"
          subPath: cfg/jupyter/.ipython
        - mountPath: "/home/jovyan/.local"
          name: "user-volume"
          subPath: cfg/jupyter/.local
      - op: add
        path: /spec/volumes
        value:
        - name: "user-volume"
          namespace: shinyproxy
          persistentVolumeClaim:
            claimName: "ceph-pvc-#{proxy.userId}"
      - op: add
        path: /spec/containers/0/resources/requests/ephemeral-storage
        value: "1Gi"

#will not persist user installed librarires